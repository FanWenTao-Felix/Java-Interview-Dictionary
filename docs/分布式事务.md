# 分布式事务

## 1.TCC分布式事务

- 先是服务调用链路依次执行Try逻辑.

- 如果都正常的话，TCC分布式事务框架推进执行Confirm逻辑，完成整个事务

- 如果某个服务的Try逻辑有问题，TCC分布式事务框架感知到之后就会推进执行各个服务的Cancel逻辑，撤销之前执行的各种操作.

## 2.基于MQ的异步调用，如何保证各个服务间的分布式事务呢？

用上**可靠消息最终一致性方案**，来实现分布式事务。

### **上游服务投递消息**

首先，上游服务需要发送一条消息给可靠消息服务。这条消息说白了，你可以认为是对下游服务一个接口的调用，里面包含了对应的一些请求参数。然后，可靠消息服务就得把这条消息存储到自己的数据库里去，状态为“待确认”。接着，上游服务就可以执行自己本地的数据库操作，根据自己的执行结果，再次调用可靠消息服务的接口。如果本地数据库操作执行成功了，那么就找可靠消息服务确认那条消息。如果本地数据库操作失败了，那么就找可靠消息服务删除那条消息。此时如果是确认消息，那么可靠消息服务就把数据库里的消息状态更新为“已发送”，同时将消息发送给MQ。

### **下游服务接收消息**

下游服务就一直等着从MQ消费消息好了，如果消费到了消息，那么就操作自己本地数据库。

如果操作成功了，就反过来通知可靠消息服务，说自己处理成功了，然后可靠消息服务就会把消息的状态设置为“已完成”。

### **如何上游服务对消息的100%可靠投递？**

在可靠消息服务里开发一个**后台定时运行的线程**，不停的检查各个消息的状态。

如果一直是“待确认”状态，就认为这个消息出了点什么问题。此时的话，就可以回调上游服务提供的一个接口，问问说，兄弟，这个消息对应的数据库操作，你执行成功了没啊？如果上游服务答复说，我执行成功了，那么可靠消息服务将消息状态修改为“已发送”，同时投递消息到MQ。如果上游服务答复说，没执行成功，那么可靠消息服务将数据库中的消息删除即可。

### **如何保证下游服务对消息的100%可靠接收？**

**在可靠消息服务里开发一个后台线程，不断的检查消息状态。**

如果消息状态一直是“已发送”，始终没有变成“已完成”，那么就说明下游服务始终没有处理成功。此时可靠消息服务就可以再次尝试重新投递消息到MQ，让下游服务来再次处理。只要下游服务的接口逻辑**实现幂等性**，保证多次处理一个消息，不会插入重复数据即可。